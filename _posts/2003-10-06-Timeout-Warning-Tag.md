---
layout: default
title: "Timeout Warning Tag"
permalink: /2003/10/06/Timeout-Warning-Tag/
---

<P>From <A href="http://www.defusion.com/articles/index.cfm?ArticleID=67" target=_blank>http://www.defusion.com/articles/index.cfm?ArticleID=67</A></P>
<P><STRONG>The Problem</STRONG> </P>
<P>Developing applications for an intranet or extranet environment that must be secure almost always leads to the idea of a session.&nbsp;&nbsp;Since http is a stateless protocol, the ability to authenticate and then authorize user access often becomes tied to sessions.&nbsp;&nbsp;ColdFusion makes much of this easy for developers with its session scoped variables.&nbsp;&nbsp;However, since session variables by definition span pages, they leave a security hole.&nbsp;&nbsp;If I login and my status is saved in a session variable, I can leave for lunch and anyone can come in and access information using my login. 
<P>The accepted solution to this problem is to timeout the session if there has not been any activity for x number of minutes.&nbsp;&nbsp;The problem with this solution is that "activity" must be either moving to a new page or refreshing the current page.&nbsp;&nbsp;Filling out form information does not count as activity when it comes to session variables.&nbsp;&nbsp;If a user is filling out a complex form and takes longer then twenty minutes (or whatever the timeout is), they are out of luck.&nbsp;&nbsp;Every time they try to submit their form and save their work, they would have timed out and lost all their information. 
<P><B>A Solution</B> 
<P>This article will develop a custom tag that helps answer this problem by popping up a warning message when the user is about to timeout.&nbsp;&nbsp;This will give the user a chance to save their work and refresh the page, before they lose their information.&nbsp;&nbsp;The tag uses a mix of ColdFusion and Javascript to accomplish this. 
<P>First, there should be three inputs or attributes for this custom tag.&nbsp;&nbsp;We need a warning threshold attribute that defines at what point the message should actually appear.&nbsp;&nbsp;This is done by specifying a number of minutes until timeout.&nbsp;&nbsp;We also need a timeout attribute to hold the session variable timeout value.&nbsp;&nbsp;Finally, we need a warning message attribute to hold the actual warning message text.&nbsp;&nbsp;Using the <FONT color=red>&lt;CFPARAM&gt;</FONT> tag, we can define attributes and set defaults for them. 
<P><FONT color=red>&lt;CFPARAM Name=<FONT color=blue>"Attributes.WarningThreshold"</FONT> Default = <FONT color=blue>"2"</FONT>&gt;</FONT><BR><FONT color=red>&lt;CFPARAM Name=<FONT color=blue>"Attributes.TimeOutMinutes"</FONT> Default=<FONT color=blue>"30"</FONT>&gt;</FONT><BR><FONT color=red>&lt;CFPARAM Name=<FONT color=blue>"Attributes.WarningMessage"</FONT> Default=<FONT color=blue>"You will timeout in #Attributes.WarningThreshold# minute(s)!"</FONT>&gt;</FONT> 
<P>The next step is to set some global Javascript variables.&nbsp;&nbsp;We need to know the time the current page was first accessed as well as the threshold time.&nbsp;&nbsp;Using time in Javascript is much easier if everything is converted to milliseconds, so the first thing we do is get the current Date/Time and convert it to milliseconds.&nbsp;&nbsp;Then we convert the Attributes.TimeOutMinutes to milliseconds and add that to the current time.&nbsp;&nbsp;Now, we have the number of milliseconds that represents the exact time the current session will timeout.&nbsp;&nbsp;Also, we convert the Attributes.Threshold to milliseconds. 
<P><FONT color=red>&lt;CFOUTPUT&gt;</FONT><BR><FONT color=navy>&lt;SCRIPT Language=<FONT color=blue>"Javascript"</FONT>&gt;</FONT> 
<P><FONT color=navy><BR>&nbsp;&nbsp;&nbsp;&nbsp;// GLOBAL VARIABLES<BR>&nbsp;&nbsp;&nbsp;&nbsp;StartTime = new Date();<BR>&nbsp;&nbsp;&nbsp;&nbsp;StartMils = Date.parse(StartTime.toLocaleString());<BR>&nbsp;&nbsp;&nbsp;&nbsp;TimeOutMils = StartMils + (60000 * #Attributes.TimeOutMinutes#);<BR>&nbsp;&nbsp;&nbsp;&nbsp;ThresholdMils = 60000 * #Attributes.WarningThreshold#;<BR></FONT><BR><BR>The next step is to create a CountDown function that will run every ten seconds and check if it has reached the given threshold.&nbsp;&nbsp;The first line of this function clears Javascript's TimeOut mechanism.&nbsp;&nbsp;Although the name is confusing in our context, it has nothing to do with the session timeout that we are dealing with.&nbsp;&nbsp;The Javascript TimeOut functions allow you to setup and run a piece of code every x number of milliseconds.&nbsp;&nbsp;We will use this later to run CountDown every ten seconds.&nbsp;&nbsp;Next, we get the current time and then convert it into milliseconds.&nbsp;&nbsp;Now we can calculate how many milliseconds are left until the timeout occurs. 
<P><FONT color=navy><BR>&nbsp;&nbsp;&nbsp;&nbsp;function CountDown()<BR>&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clearTimeout('cd');&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CurrentTime = new Date();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CurrentMils = Date.parse(CurrentTime.toLocaleString());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemainingMils = TimeOutMils - CurrentMils;<BR></FONT>
<P>Once we have the number of milliseconds until timeout, we can compare that to the threshold milliseconds.&nbsp;&nbsp;If the number of milliseconds until timeout is less than the threshold milliseconds, then we display the warning message.&nbsp;&nbsp;If we have not reached the threshold then we use Javascript's setTimeOut function to run our CountDown function again in ten seconds. 
<P><FONT color=navy><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(RemainingMils &lt; ThresholdMils)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window.alert("#Attributes.WarningMessage#");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cd = setTimeout('CountDown()', 10000);<BR>&nbsp;&nbsp;&nbsp;&nbsp;}<BR></FONT>
<P>We have to remember to run the CountDown function for the first time.&nbsp;&nbsp;You can call it in the <FONT color=navy>&lt;BODY&gt;</FONT> tag's onLoad function or just call it with inline Javascript. 
<P><FONT color=navy><BR>&nbsp;&nbsp;&nbsp;&nbsp;CountDown();<BR></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR><FONT color=navy>&lt;/SCRIPT&gt;</FONT><BR><FONT color=red>&lt;/CFOUTPUT&gt;</FONT> 
<P>Save the preceding code as C:\Cfusion\CustomTags\TimeOutWarning.cfm and you can use the tag by simply calling <FONT color=red>&lt;CF_TIMEOUTWARNING&gt;</FONT>.&nbsp;&nbsp;For testing, add <FONT color=red>&lt;CF_TIMEOUTWARNING WarningThreshold=<FONT color=blue>"1"</FONT> TimeOutMinutes=<FONT color=blue>"2"</FONT>&gt;</FONT> to a ColdFusion page.&nbsp;&nbsp;About a minute after loading the page, a message will pop up warning that you are about to timeout. 
<P>A stateless environment allows the easy development of multi-user distributed applications, but it can really hinder user interface.&nbsp;&nbsp;Although this tag does not solve the problem inherent in a stateless environment, it does help improve the user's experience by giving them timely feedback.</P>